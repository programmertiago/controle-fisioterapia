<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Fisioterapia Colaborativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .patient-summary.active { background-color: #f0f9ff; }
        .details-content { transition: max-height 0.3s ease-in-out; max-height: 0; overflow: hidden; border-top: 1px solid transparent; }
        .details-content.open { max-height: 500px; padding-top: 1rem; padding-bottom: 1.5rem; border-top-color: #e5e7eb; }
        textarea { resize: vertical; }
        .status-pendente { background-color: #f3f4f6; }
        .status-atendido { background-color: #dcfce7; }
        .drag-handle { cursor: grab; }
        .sortable-ghost { opacity: 0.4; background: #c7d2fe; }
        .sortable-chosen { cursor: grabbing; }
        #loading-overlay, #auth-overlay { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Tela de Autenticação -->
    <div id="auth-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Controle de Fisioterapia</h2>
            <p class="text-slate-600 mb-6">Por favor, identifique-se para continuar.</p>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="Seu e-mail" class="w-full p-3 border border-slate-300 rounded-lg text-center">
                <input type="password" id="password-input" placeholder="Sua senha" class="w-full p-3 border border-slate-300 rounded-lg text-center">
            </div>
            <div class="mt-6 space-y-3">
                 <button id="login-btn" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all">Entrar</button>
                 <button id="register-btn" class="w-full py-2 text-blue-600 font-medium rounded-lg hover:bg-blue-50 transition-all">Não tenho conta, quero me registrar</button>
            </div>
            <p id="auth-error" class="text-red-500 text-sm mt-4 h-4"></p>
        </div>
    </div>
    
    <!-- Tela de Carregamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-40 hidden">
         <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
         <p class="mt-4 text-slate-600">Carregando dados...</p>
    </div>

    <!-- Conteúdo Principal da Aplicação -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Controle Diário de Fisioterapia</h1>
                <p class="text-slate-600 mt-1">Dados sincronizados em tempo real.</p>
            </div>
            <div class="text-right mt-4 md:mt-0">
                <p id="user-display" class="font-semibold text-slate-700"></p>
                <button id="logout-btn" class="text-sm text-blue-600 hover:underline">Sair</button>
            </div>
        </header>
        
        <div id="filter-bar" class="bg-white p-4 rounded-xl shadow-md mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="filter-data" class="block text-sm font-medium text-slate-700 mb-1">Visualizar Data</label>
                    <input type="date" id="filter-data" class="w-full p-2 border border-slate-300 rounded-lg">
                </div>
                <div>
                    <label for="filter-turno" class="block text-sm font-medium text-slate-700 mb-1">Turno</label>
                    <select id="filter-turno" class="w-full p-2 border border-slate-300 rounded-lg">
                        <option value="todos">Todos</option>
                        <option value="manha">Manhã</option>
                        <option value="tarde">Tarde</option>
                    </select>
                </div>
                 <div>
                    <label for="filter-setor" class="block text-sm font-medium text-slate-700 mb-1">Setor</label>
                    <select id="filter-setor" class="w-full p-2 border border-slate-300 rounded-lg">
                        <option value="todos">Todos</option>
                        <option>1° Enfermaria</option>
                        <option>2° Enfermaria</option>
                        <option>3° Enfermaria</option>
                        <option>UTI</option>
                    </select>
                </div>
                <div>
                    <!-- Espaço para futuros filtros -->
                </div>
            </div>
        </div>

        <main id="patient-container" class="space-y-4"></main>
        
        <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="add-patient-btn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700">
                Adicionar Paciente
            </button>
        </div>
    </div>

    <!-- Template de Paciente (invisível) -->
    <div id="patient-template" class="patient-card hidden">
        <div class="patient-summary p-4 cursor-pointer">
            <div class="grid grid-cols-12 gap-x-4 gap-y-2 items-center">
                <div class="col-drag md:col-span-1 flex items-center text-slate-400 drag-handle"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></div>
                <div class="col-status md:col-span-1 flex items-center"><button class="status-btn p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></button></div>
                <div class="col-nome md:col-span-3"><input type="text" data-field="nome" placeholder="Nome do Paciente" class="w-full font-bold text-lg p-1 rounded-md bg-transparent focus:bg-slate-100"></div>
                <div class="col-leito md:col-span-1"><label class="font-semibold text-slate-500 text-xs">Leito:</label><input type="text" data-field="leito" placeholder="Ex: 201-A" class="w-full p-1 rounded-md bg-transparent focus:bg-slate-100"></div>
                <div class="col-idade md:col-span-1"><label class="font-semibold text-slate-500 text-xs">Idade:</label><input type="number" data-field="idade" placeholder="Anos" class="w-full p-1 rounded-md bg-transparent focus:bg-slate-100"></div>
                <div class="col-diagnostico md:col-span-4"><label class="font-semibold text-slate-500 text-xs">Diagnóstico:</label><input type="text" data-field="diagnostico" placeholder="Diagnóstico clínico" class="w-full p-1 rounded-md bg-transparent focus:bg-slate-100"></div>
                <div class="col-remover md:col-span-1 flex justify-end"><button class="remove-btn p-2 rounded-full text-slate-400 hover:text-red-500 hover:bg-red-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            </div>
        </div>
        <div class="details-content px-4">
            <div class="flex justify-between items-center mb-2">
                 <label class="block text-sm font-medium text-slate-700">Avaliação / Conduta / Evolução</label>
                 <p class="text-xs text-slate-400 italic last-updated-by"></p>
            </div>
            <textarea rows="10" data-field="evolucao" class="w-full p-3 border border-slate-200 rounded-lg bg-slate-50" placeholder="Descreva aqui o atendimento..."></textarea>
        </div>
    </div>
    
    <!-- Módulos do Firebase -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, orderBy, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Sua configuração do Firebase que você forneceu
        const firebaseConfig = {
            apiKey: "AIzaSyD-2HF1KBOPjx-3FwxV_pcD0UauB5asg74",
            authDomain: "passandoplantao.firebaseapp.com",
            projectId: "passandoplantao",
            storageBucket: "passandoplantao.appspot.com", // Corrigido para .appspot.com
            messagingSenderId: "293699114625",
            appId: "1:293699114625:web:fda370ee7b4e1f64e01f80",
            measurementId: "G-DMGVY7J4JV"
        };

        // Inicialização dos serviços
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let unsubscribePatients = null;

        const authOverlay = document.getElementById('auth-overlay');
        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');
        const patientContainer = document.getElementById('patient-container');

        // --- Lógica de Autenticação ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                authOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('user-display').textContent = `Bem-vindo(a), ${user.email.split('@')[0]}`;
                setupFilters();
            } else {
                currentUser = null;
                authOverlay.classList.remove('hidden');
                loadingOverlay.classList.add('hidden');
                appContainer.classList.add('hidden');
                if(unsubscribePatients) unsubscribePatients();
            }
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            document.getElementById('auth-error').textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    document.getElementById('auth-error').textContent = "E-mail ou senha incorretos.";
                });
        });
        
        document.getElementById('register-btn').addEventListener('click', () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            document.getElementById('auth-error').textContent = '';
            if (email.length < 6 || password.length < 6) {
                document.getElementById('auth-error').textContent = "E-mail e senha devem ter no mínimo 6 caracteres.";
                return;
            }
            createUserWithEmailAndPassword(auth, email, password)
                .then(() => {
                     document.getElementById('auth-error').textContent = "Registro bem-sucedido! Faça o login.";
                })
                .catch(error => {
                    document.getElementById('auth-error').textContent = "Erro ao registrar. O e-mail já pode existir.";
                });
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));


        // --- Lógica do Aplicativo ---
        
        function setupFilters() {
            const dateFilter = document.getElementById('filter-data');
            const turnoFilter = document.getElementById('filter-turno');
            const setorFilter = document.getElementById('filter-setor');

            dateFilter.value = new Date().toISOString().split('T')[0];
            
            loadPatients();

            [dateFilter, turnoFilter, setorFilter].forEach(el => {
                el.addEventListener('change', loadPatients);
            });
            
            document.getElementById('add-patient-btn').onclick = addPatient;
        }

        function loadPatients() {
            loadingOverlay.classList.remove('hidden');
            if (unsubscribePatients) {
                unsubscribePatients();
            }
            
            const date = document.getElementById('filter-data').value;
            if (!date) {
                loadingOverlay.classList.add('hidden');
                patientContainer.innerHTML = '<p class="text-center text-slate-500">Selecione uma data para ver os pacientes.</p>';
                return;
            }
            
            let q = query(collection(db, "atendimentos", date, "pacientes"), orderBy("order"));
            
            unsubscribePatients = onSnapshot(q, (snapshot) => {
                const patientsData = [];
                snapshot.forEach(doc => {
                    patientsData.push({ id: doc.id, ...doc.data() });
                });
                renderPatients(patientsData);
                loadingOverlay.classList.add('hidden');
            }, (error) => {
                console.error("Erro ao carregar pacientes: ", error);
                loadingOverlay.classList.add('hidden');
            });
        }
        
        function renderPatients(patients) {
            patientContainer.innerHTML = '';
            const turnoFilter = document.getElementById('filter-turno').value;
            const setorFilter = document.getElementById('filter-setor').value;
            
            patients
              .filter(p => (turnoFilter === 'todos' || p.turno === turnoFilter))
              .filter(p => (setorFilter === 'todos' || p.setor === setorFilter))
              .forEach(patientData => createPatientCard(patientData.id, patientData));
        }

        function createPatientCard(id, data) {
            const template = document.getElementById('patient-template');
            const card = template.cloneNode(true);
            card.id = id;
            card.classList.remove('hidden');

            const summary = card.querySelector('.patient-summary');
            const details = card.querySelector('.details-content');

            card.querySelector('[data-field="nome"]').value = data.nome || '';
            card.querySelector('[data-field="leito"]').value = data.leito || '';
            card.querySelector('[data-field="idade"]').value = data.idade || '';
            card.querySelector('[data-field="diagnostico"]').value = data.diagnostico || '';
            card.querySelector('[data-field="evolucao"]').value = data.evolucao || '';
            
            if (data.lastUpdatedBy) {
                card.querySelector('.last-updated-by').textContent = `Atualizado por: ${data.lastUpdatedBy.split('@')[0]}`;
            }

            updateStatus(card, data.status, false);
            if (data.isOpen) {
                summary.classList.add('active');
                details.classList.add('open');
            }

            const debouncedUpdate = debounce((dataToUpdate) => updatePatient(id, dataToUpdate), 500);

            card.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('input', () => debouncedUpdate({ [el.dataset.field]: el.value }));
            });

            card.querySelector('.status-btn').addEventListener('click', () => {
                const newStatus = card.dataset.status === 'pendente' ? 'atendido' : 'pendente';
                updatePatient(id, { status: newStatus });
            });
            card.querySelector('.remove-btn').addEventListener('click', () => deletePatient(id));
            summary.addEventListener('click', (e) => {
                 if (e.target.closest('input, button, .drag-handle')) return;
                 details.classList.toggle('open');
                 updatePatient(id, { isOpen: details.classList.contains('open') });
            });

            patientContainer.appendChild(card);
        }

        async function addPatient() {
            const date = document.getElementById('filter-data').value;
            const turno = document.getElementById('filter-turno').value;
            const setor = document.getElementById('filter-setor').value;
            
            if (!date) {
                alert("Por favor, selecione uma data para adicionar pacientes.");
                return;
            }
            
            const newId = doc(collection(db, "atendimentos", date, "pacientes")).id;
            const newPatientData = {
                id: newId,
                nome: 'Novo Paciente', leito: '', idade: '', diagnostico: '',
                status: 'pendente',
                evolucao: 'SINAIS VITAIS:\nPA: mmHg | FC: bpm | SpO₂: %\n\nAVALIAÇÃO:\n\n\nCONDUTA REALIZADA:\n\n\nEVOLUÇÃO/OBSERVAÇÕES:\n',
                order: patientContainer.children.length,
                createdAt: new Date(),
                lastUpdatedBy: currentUser.email,
                isOpen: true,
                turno: turno === 'todos' ? 'manha' : turno,
                setor: setor === 'todos' ? '1° Enfermaria' : setor,
            };

            await setDoc(doc(db, "atendimentos", date, "pacientes", newId), newPatientData);
        }

        async function updatePatient(id, dataToUpdate) {
            const date = document.getElementById('filter-data').value;
            const docRef = doc(db, "atendimentos", date, "pacientes", id);
            await setDoc(docRef, { ...dataToUpdate, lastUpdatedBy: currentUser.email }, { merge: true });
        }
        
        async function deletePatient(id) {
            if (!confirm("Tem certeza que deseja remover este paciente?")) return;
            const date = document.getElementById('filter-data').value;
            await deleteDoc(doc(db, "atendimentos", date, "pacientes", id));
        }

        function updateStatus(card, status) {
            card.dataset.status = status;
            const summary = card.querySelector('.patient-summary');
            summary.classList.remove('status-pendente', 'status-atendido');
            summary.classList.add(`status-${status}`);
        }
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // Inicialização do Sortable
        new Sortable(patientContainer, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            onEnd: async (evt) => {
                const date = document.getElementById('filter-data').value;
                const batch = writeBatch(db);
                const items = evt.from.children;
                for (let i = 0; i < items.length; i++) {
                    const docId = items[i].id;
                    const docRef = doc(db, "atendimentos", date, "pacientes", docId);
                    batch.update(docRef, { order: i });
                }
                await batch.commit();
            }
        });

    </script>
</body>
</html>
