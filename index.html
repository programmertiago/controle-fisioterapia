<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Fisioterapia Colaborativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .patient-summary.active { background-color: #f0f9ff; }
        .details-content { transition: max-height 0.3s ease-in-out; max-height: 0; overflow: hidden; border-top: 1px solid transparent; }
        .details-content.open { max-height: 500px; padding-top: 1rem; padding-bottom: 1.5rem; border-top-color: #e5e7eb; }
        textarea { resize: vertical; }
        .status-pendente { background-color: #f3f4f6; }
        .status-atendido { background-color: #dcfce7; }
        .drag-handle { cursor: grab; }
        .sortable-ghost { opacity: 0.4; background: #c7d2fe; }
        .sortable-chosen { cursor: grabbing; }
        #loading-overlay, #auth-overlay, .modal-overlay { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Tela de Autenticação -->
    <div id="auth-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Controle de Fisioterapia</h2>
            <p class="text-slate-600 mb-6">Por favor, identifique-se para continuar.</p>
            <div class="space-y-4">
                <input type="email" id="email-input" autocomplete="off" placeholder="Seu e-mail" class="w-full p-3 border border-slate-300 rounded-lg text-center">
                <input type="password" id="password-input" autocomplete="off" placeholder="Sua senha" class="w-full p-3 border border-slate-300 rounded-lg text-center">
            </div>
            <div class="mt-6 space-y-3">
                 <button id="login-btn" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all">Entrar</button>
                 <button id="register-btn" class="hidden w-full py-2 text-blue-600 font-medium rounded-lg hover:bg-blue-50 transition-all">Criar conta de Administrador</button>
            </div>
            <button id="forgot-password-btn" class="text-sm text-slate-500 hover:underline mt-4">Esqueceu a senha?</button>
            <p id="auth-error" class="text-red-500 text-sm mt-2 h-4"></p>
        </div>
    </div>
    
    <!-- Tela de Carregamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-40 hidden">
         <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
         <p id="loading-text" class="mt-4 text-slate-600">Carregando dados...</p>
    </div>

    <!-- Conteúdo Principal da Aplicação -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Controle Diário de Fisioterapia</h1>
                <p class="text-slate-600 mt-1">Dados sincronizados em tempo real.</p>
            </div>
            <div class="flex items-center gap-4 text-right mt-4 md:mt-0">
                <button id="admin-panel-btn" class="hidden p-2 rounded-full hover:bg-slate-200" title="Gerir Utilizadores">
                    <svg class="h-6 w-6 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <div>
                    <p id="user-display" class="font-semibold text-slate-700"></p>
                    <button id="logout-btn" class="text-sm text-blue-600 hover:underline">Sair</button>
                </div>
            </div>
        </header>
        
        <div id="filter-bar" class="bg-white p-4 rounded-xl shadow-md mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="filter-data" class="block text-sm font-medium text-slate-700 mb-1">Visualizar Data</label>
                    <input type="date" id="filter-data" class="w-full p-2 border border-slate-300 rounded-lg">
                </div>
                <div>
                    <label for="filter-turno" class="block text-sm font-medium text-slate-700 mb-1">Turno</label>
                    <select id="filter-turno" class="w-full p-2 border border-slate-300 rounded-lg">
                        <option value="todos">Todos</option>
                        <option value="manha">Manhã</option>
                        <option value="tarde">Tarde</option>
                    </select>
                </div>
                 <div>
                    <label for="filter-setor" class="block text-sm font-medium text-slate-700 mb-1">Setor</label>
                    <select id="filter-setor" class="w-full p-2 border border-slate-300 rounded-lg">
                        <option value="todos">Todos</option>
                        <option>1° Enfermaria</option>
                        <option>2° Enfermaria</option>
                        <option>3° Enfermaria</option>
                        <option>UTI</option>
                    </select>
                </div>
                <div></div>
            </div>
        </div>

        <main id="patient-container" class="space-y-4"></main>
        
        <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
            <button id="copy-day-btn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700">Copiar Dia Anterior</button>
            <button id="add-patient-btn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700">Adicionar Paciente</button>
        </div>
    </div>

    <div id="patient-template" class="patient-card hidden">
        <div class="patient-summary p-4 cursor-pointer">
            <div class="grid grid-cols-12 gap-x-4 gap-y-2 items-center">
                <div class="md:col-span-1 flex items-center text-slate-400 drag-handle"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></div>
                <div class="md:col-span-1 flex items-center"><button class="status-btn p-2 rounded-full"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></button></div>
                <div class="md:col-span-3"><input type="text" data-field="nome" placeholder="Nome do Paciente" class="w-full font-bold text-lg p-1 rounded-md bg-transparent focus:bg-slate-100"></div>
                <div class="md:col-span-1"><label class="font-semibold text-slate-500 text-xs">Leito:</label><input type="text" data-field="leito" placeholder="Ex: 201-A" class="w-full p-1 rounded-md bg-transparent focus:bg-slate-100"></div>
                <div class="md:col-span-1"><label class="font-semibold text-slate-500 text-xs">Idade:</label><input type="number" data-field="idade" placeholder="Anos" class="w-full p-1 rounded-md bg-transparent focus:bg-slate-100"></div>
                <div class="md:col-span-3"><label class="font-semibold text-slate-500 text-xs">Diagnóstico:</label><input type="text" data-field="diagnostico" placeholder="Diagnóstico clínico" class="w-full p-1 rounded-md bg-transparent focus:bg-slate-100"></div>
                <div class="md:col-span-2 flex justify-end items-center space-x-1">
                    <button class="view-btn p-2 rounded-full text-slate-400 hover:text-green-500 hover:bg-green-100"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></button>
                    <button class="transfer-btn p-2 rounded-full text-slate-400 hover:text-blue-500 hover:bg-blue-100"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg></button>
                    <button class="remove-btn p-2 rounded-full text-slate-400 hover:text-red-500 hover:bg-red-100"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>
            </div>
        </div>
        <div class="details-content px-4">
            <div class="flex justify-between items-center mb-2">
                 <label class="block text-sm font-medium text-slate-700">Avaliação / Conduta / Evolução</label>
                 <p class="text-xs text-slate-400 italic last-updated-by"></p>
            </div>
            <textarea rows="10" data-field="evolucao" class="w-full p-3 border border-slate-200 rounded-lg bg-slate-50" placeholder="Descreva aqui o atendimento..."></textarea>
        </div>
    </div>
    
    <div id="transfer-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-slate-800">Transferir Paciente</h3>
            <p id="transfer-patient-name" class="text-slate-600 my-2"></p>
            <div class="mt-4">
                <label for="transfer-setor-select" class="block text-sm font-medium text-slate-700 mb-1">Transferir para o setor:</label>
                <select id="transfer-setor-select" class="w-full p-2 border border-slate-300 rounded-lg">
                    <option>1° Enfermaria</option>
                    <option>2° Enfermaria</option>
                    <option>3° Enfermaria</option>
                    <option>UTI</option>
                </select>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-transfer-btn" class="py-2 px-6 bg-slate-200 rounded-lg font-semibold hover:bg-slate-300">Cancelar</button>
                <button id="confirm-transfer-btn" class="py-2 px-6 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Gestão de Utilizadores</h3>
            
            <div class="mb-6 p-4 border rounded-lg">
                <h4 class="font-semibold mb-2">Adicionar Novo Fisioterapeuta</h4>
                <div class="flex items-center gap-4">
                    <input type="email" id="new-user-email" placeholder="E-mail do novo utilizador" class="flex-grow p-2 border rounded-lg">
                    <input type="password" id="new-user-password" placeholder="Senha temporária" class="flex-grow p-2 border rounded-lg">
                    <button id="add-new-user-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Adicionar</button>
                </div>
                 <p id="admin-error" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>

            <div class="flex-grow overflow-y-auto">
                <h4 class="font-semibold mb-2">Utilizadores Registados</h4>
                <ul id="users-list" class="space-y-2"></ul>
            </div>

            <div class="flex justify-end gap-4 mt-6">
                <button id="close-admin-modal-btn" class="py-2 px-6 bg-slate-200 rounded-lg font-semibold hover:bg-slate-300">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, deleteDoc, writeBatch, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-2HF1KBOPjx-3FwxV_pcD0UauB5asg74",
            authDomain: "passandoplantao.firebaseapp.com",
            projectId: "passandoplantao",
            storageBucket: "passandoplantao.appspot.com",
            messagingSenderId: "293699114625",
            appId: "1:293699114625:web:fda370ee7b4e1f64e01f80",
            measurementId: "G-DMGVY7J4JV"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let unsubscribePatients = null;
        let unsubscribeUsers = null;
        let currentDayPatients = new Map();

        const authOverlay = document.getElementById('auth-overlay');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const appContainer = document.getElementById('app-container');
        const patientContainer = document.getElementById('patient-container');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const transferModal = document.getElementById('transfer-modal');
        const adminModal = document.getElementById('admin-modal');
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const authError = document.getElementById('auth-error');

        // --- Lógica de Autenticação e Funções (Roles) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                const userRole = userDoc.exists() ? userDoc.data().role : null;
                adminPanelBtn.classList.toggle('hidden', userRole !== 'admin');
                
                authOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('user-display').textContent = `Bem-vindo(a), ${user.email.split('@')[0]}`;
                setupFilters();
            } else {
                authOverlay.classList.remove('hidden');
                loadingOverlay.classList.add('hidden');
                appContainer.classList.add('hidden');
                adminPanelBtn.classList.add('hidden');
                if (unsubscribePatients) unsubscribePatients();
                if (unsubscribeUsers) unsubscribeUsers();
            }
        });

        // Verifica se existem utilizadores para decidir se mostra o botão de registo
        getDocs(collection(db, "users")).then(snapshot => {
            const registerBtn = document.getElementById('register-btn');
            if (snapshot.empty) {
                registerBtn.classList.remove('hidden');
            } else {
                registerBtn.classList.add('hidden');
            }
        });

        document.getElementById('register-btn').addEventListener('click', async () => {
            const usersSnapshot = await getDocs(collection(db, "users"));
            if (!usersSnapshot.empty) {
                authError.textContent = "O registo está desativado.";
                return;
            }
            const email = emailInput.value;
            const password = passwordInput.value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    email: email, role: 'admin', createdAt: serverTimestamp()
                });
                authError.textContent = "Conta de Admin criada! Faça o login.";
                document.getElementById('register-btn').classList.add('hidden');
            } catch (error) {
                authError.textContent = "Erro ao criar conta.";
            }
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            authError.textContent = '';
            signInWithEmailAndPassword(auth, email, password).catch(error => {
                authError.textContent = "E-mail ou senha incorretos.";
            });
        });
        
        document.getElementById('forgot-password-btn').addEventListener('click', () => {
            const email = emailInput.value;
            authError.textContent = '';
            if (!email) {
                authError.textContent = "Por favor, digite o seu e-mail para recuperar a senha.";
                return;
            }
            sendPasswordResetEmail(auth, email).then(() => {
                authError.textContent = "E-mail de recuperação de senha enviado!";
            }).catch((error) => {
                authError.textContent = "Erro ao enviar e-mail. Verifique se o e-mail está correto.";
            });
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                emailInput.value = '';
                passwordInput.value = '';
            });
        });

        // --- Gestão de Utilizadores (Admin) ---
        adminPanelBtn.addEventListener('click', () => {
            adminModal.classList.remove('hidden');
            loadUsersForAdminPanel();
        });

        document.getElementById('close-admin-modal-btn').addEventListener('click', () => {
            adminModal.classList.add('hidden');
            if (unsubscribeUsers) unsubscribeUsers();
        });

        async function loadUsersForAdminPanel() {
            const usersList = document.getElementById('users-list');
            unsubscribeUsers = onSnapshot(collection(db, "users"), (snapshot) => {
                usersList.innerHTML = '';
                snapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-2 border-b';
                    li.innerHTML = `<div><p class="font-semibold">${userData.email}</p><p class="text-sm text-slate-500">Função: ${userData.role}</p></div><button class="delete-user-btn text-red-500 p-2 rounded-full hover:bg-red-100" data-uid="${userDoc.id}" title="Remover Utilizador"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                    li.querySelector('.delete-user-btn').addEventListener('click', async (e) => {
                        const uidToDelete = e.currentTarget.dataset.uid;
                        if(confirm(`Tem a certeza que quer remover o utilizador ${userData.email}? Esta ação não pode ser desfeita e requer uma Cloud Function para remoção completa.`)){
                            await deleteDoc(doc(db, "users", uidToDelete));
                        }
                    });
                    usersList.appendChild(li);
                });
            });
        }
        
        document.getElementById('add-new-user-btn').addEventListener('click', async () => {
             const email = document.getElementById('new-user-email').value;
             const password = document.getElementById('new-user-password').value;
             const adminError = document.getElementById('admin-error');
             adminError.textContent = '';

             if (!email || password.length < 6) {
                 adminError.textContent = 'E-mail inválido ou senha muito curta.';
                 return;
             }
             
             try {
                // A forma correta e segura é usar Cloud Functions para criar utilizadores.
                // Esta é uma alternativa simplificada que cria o utilizador no lado do cliente.
                const tempApp = initializeApp(firebaseConfig, `Secondary-${Date.now()}`);
                const tempAuth = getAuth(tempApp);
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    email: email, role: 'fisioterapeuta', createdAt: serverTimestamp()
                });

                await signOut(tempAuth);
                document.getElementById('new-user-email').value = '';
                document.getElementById('new-user-password').value = '';
                adminError.textContent = 'Utilizador adicionado com sucesso!';
             } catch(error) {
                console.error("Erro ao adicionar utilizador:", error);
                adminError.textContent = 'Erro ao adicionar. O e-mail pode já existir.';
             }
        });


        // --- Lógica Principal da Aplicação ---
        
        function setupFilters() {
            const dateFilter = document.getElementById('filter-data');
            const turnoFilter = document.getElementById('filter-turno');
            const setorFilter = document.getElementById('filter-setor');
            dateFilter.value = new Date().toISOString().split('T')[0];
            
            dateFilter.addEventListener('change', loadPatients);
            [turnoFilter, setorFilter].forEach(el => el.addEventListener('change', applyFiltersAndRender));
            
            loadPatients();
            
            document.getElementById('add-patient-btn').onclick = addPatient;
            document.getElementById('copy-day-btn').onclick = copyFromPreviousDay;
        }

        function loadPatients() {
            setLoading(true, "A carregar pacientes...");
            if (unsubscribePatients) unsubscribePatients();
            
            patientContainer.innerHTML = '';
            currentDayPatients.clear();

            const date = document.getElementById('filter-data').value;
            if (!date) {
                setLoading(false);
                patientContainer.innerHTML = '<p class="text-center text-slate-500">Selecione uma data para ver os pacientes.</p>';
                return;
            }
            
            const q = query(collection(db, "atendimentos", date, "pacientes"), orderBy("order"));
            
            unsubscribePatients = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const docData = { id: change.doc.id, ...change.doc.data() };
                    const docId = change.doc.id;
                    
                    if (change.type === "added") {
                        currentDayPatients.set(docId, docData);
                    } else if (change.type === "modified") {
                        currentDayPatients.set(docId, docData);
                        updateCardInPlace(docId, docData);
                    } else if (change.type === "removed") {
                        currentDayPatients.delete(docId);
                        const cardToRemove = document.getElementById(docId);
                        if (cardToRemove) cardToRemove.remove();
                    }
                });
                applyFiltersAndRender();
                setLoading(false);
            }, (error) => {
                console.error("Erro ao carregar pacientes: ", error);
                setLoading(false);
            });
        }
        
        function applyFiltersAndRender() {
            const turnoFilter = document.getElementById('filter-turno').value;
            const setorFilter = document.getElementById('filter-setor').value;
            
            const sortedPatients = Array.from(currentDayPatients.values()).sort((a, b) => a.order - b.order);
            patientContainer.innerHTML = ''; // Limpa antes de redesenhar

            const filteredPatients = sortedPatients
              .filter(p => (turnoFilter === 'todos' || !p.turno || p.turno === turnoFilter))
              .filter(p => (setorFilter === 'todos' || !p.setor || p.setor === setorFilter));
            
            if (filteredPatients.length === 0 && currentDayPatients.size > 0) {
                 patientContainer.innerHTML = '<p class="text-center text-slate-500 py-8">Nenhum paciente encontrado para os filtros selecionados.</p>';
            } else if (filteredPatients.length === 0 && currentDayPatients.size === 0) {
                 patientContainer.innerHTML = '<p class="text-center text-slate-500 py-8">Nenhum paciente registado para este dia.</p>';
            } else {
                filteredPatients.forEach(patientData => {
                    createPatientCard(patientData.id, patientData);
                });
            }
        }

        function updateCardInPlace(id, data) {
            const card = document.getElementById(id);
            if (!card) return;

            card.dataset.setor = data.setor;
            card.dataset.turno = data.turno;

            card.querySelectorAll('[data-field]').forEach(el => {
                if (document.activeElement !== el && el.value !== data[el.dataset.field]) {
                    el.value = data[el.dataset.field] || '';
                }
            });

            if (data.lastUpdatedBy) {
                card.querySelector('.last-updated-by').textContent = `Atualizado por: ${data.lastUpdatedBy.split('@')[0]}`;
            }

            updateStatus(card, data.status);
            
            const details = card.querySelector('.details-content');
            const summary = card.querySelector('.patient-summary');
            if (data.isOpen !== details.classList.contains('open')) {
                details.classList.toggle('open');
                summary.classList.toggle('active');
            }
        }

        function createPatientCard(id, data) {
            const template = document.getElementById('patient-template');
            const card = template.cloneNode(true);
            card.id = id;
            card.dataset.setor = data.setor;
            card.dataset.turno = data.turno;

            const summary = card.querySelector('.patient-summary');
            const details = card.querySelector('.details-content');

            card.querySelectorAll('[data-field]').forEach(el => {
                 el.value = data[el.dataset.field] || '';
                 el.id = `field-${id}-${el.dataset.field}`;
            });
            
            if (data.lastUpdatedBy) {
                card.querySelector('.last-updated-by').textContent = `Atualizado por: ${data.lastUpdatedBy.split('@')[0]}`;
            }

            updateStatus(card, data.status, false);
            if (data.isOpen) {
                summary.classList.add('active');
                details.classList.add('open');
            }

            const toggleDetails = () => {
                details.classList.toggle('open');
                summary.classList.toggle('active');
                updatePatient(id, { isOpen: details.classList.contains('open') });
            };

            const debouncedUpdate = debounce((dataToUpdate) => updatePatient(id, dataToUpdate), 400);

            card.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('input', () => debouncedUpdate({ [el.dataset.field]: el.value }));
            });

            card.querySelector('.status-btn').addEventListener('click', () => {
                const newStatus = card.dataset.status === 'pendente' ? 'atendido' : 'pendente';
                updatePatient(id, { status: newStatus });
            });
            card.querySelector('.remove-btn').addEventListener('click', () => deletePatient(id));
            card.querySelector('.transfer-btn').addEventListener('click', () => showTransferModal(id, data.nome));
            card.querySelector('.view-btn').addEventListener('click', toggleDetails);
            summary.addEventListener('click', (e) => {
                 if (e.target.closest('input, button, .drag-handle')) return;
                 toggleDetails();
            });

            patientContainer.appendChild(card);
        }

        async function addPatient() {
            const date = document.getElementById('filter-data').value;
            const turno = document.getElementById('filter-turno').value;
            const setor = document.getElementById('filter-setor').value;
            
            if (!date) return alert("Por favor, selecione uma data para adicionar pacientes.");
            
            const newDocRef = doc(collection(db, "atendimentos", date, "pacientes"));
            const newPatientData = {
                nome: 'Novo Paciente', leito: '', idade: '', diagnostico: '',
                status: 'pendente',
                evolucao: 'SINAIS VITAIS:\nPA: mmHg | FC: bpm | SpO₂: %\n\nAVALIAÇÃO:\n\n\nCONDUTA REALIZADA:\n\n\nEVOLUÇÃO/OBSERVAÇÕES:\n',
                order: Array.from(currentDayPatients.values()).length,
                createdAt: serverTimestamp(),
                lastUpdatedBy: auth.currentUser.email,
                isOpen: true,
                turno: turno === 'todos' ? 'manha' : turno,
                setor: setor === 'todos' ? '1° Enfermaria' : setor,
            };

            await setDoc(newDocRef, newPatientData);
        }

        async function copyFromPreviousDay() {
            const currentDateStr = document.getElementById('filter-data').value;
            if(!currentDateStr) return alert("Por favor, selecione uma data primeiro.");

            const currentDate = new Date(currentDateStr + 'T12:00:00Z');
            const previousDate = new Date(currentDate);
            previousDate.setDate(currentDate.getDate() - 1);
            const previousDateStr = previousDate.toISOString().split('T')[0];

            if(!confirm(`Deseja copiar os pacientes de ${previousDateStr} para a lista de hoje? Eles serão adicionados aos pacientes já existentes.`)) return;
            
            setLoading(true, `A copiar pacientes de ${previousDateStr}...`);

            try {
                const prevDayQuery = query(collection(db, "atendimentos", previousDateStr, "pacientes"));
                const querySnapshot = await getDocs(prevDayQuery);

                if (querySnapshot.empty) {
                    alert(`Nenhum paciente encontrado no dia ${previousDateStr}.`);
                    return;
                }

                const batch = writeBatch(db);
                const currentPatientsCount = Array.from(currentDayPatients.values()).length;
                let copiedCount = 0;

                querySnapshot.forEach((docSnap, index) => {
                    const oldData = docSnap.data();
                    const newDocRef = doc(collection(db, "atendimentos", currentDateStr, "pacientes"));
                    
                    const newPatientData = {
                        nome: oldData.nome, leito: oldData.leito, idade: oldData.idade, diagnostico: oldData.diagnostico,
                        setor: oldData.setor, turno: oldData.turno, status: 'pendente',
                        evolucao: 'SINAIS VITAIS:\nPA: mmHg | FC: bpm | SpO₂: %\n\nAVALIAÇÃO:\n\n\nCONDUTA REALIZADA:\n\n\nEVOLUÇÃO/OBSERVAÇÕES:\n',
                        order: currentPatientsCount + index, createdAt: serverTimestamp(),
                        lastUpdatedBy: auth.currentUser.email, isOpen: false
                    };
                    batch.set(newDocRef, newPatientData);
                    copiedCount++;
                });

                await batch.commit();
                alert(`${copiedCount} paciente(s) copiado(s) com sucesso!`);

            } catch (error) {
                console.error("Erro ao copiar pacientes: ", error);
                alert("Ocorreu um erro ao tentar copiar os pacientes. Verifique a consola para mais detalhes.");
            } finally {
                setLoading(false);
            }
        }

        async function updatePatient(id, dataToUpdate) {
            const date = document.getElementById('filter-data').value;
            const docRef = doc(db, "atendimentos", date, "pacientes", id);
            await setDoc(docRef, { ...dataToUpdate, lastUpdatedBy: auth.currentUser.email, lastUpdatedAt: serverTimestamp() }, { merge: true });
        }
        
        async function deletePatient(id) {
            if (!confirm("Tem a certeza que deseja remover este paciente?")) return;
            const date = document.getElementById('filter-data').value;
            await deleteDoc(doc(db, "atendimentos", date, "pacientes", id));
        }

        function updateStatus(card, status) {
            card.dataset.status = status;
            const summary = card.querySelector('.patient-summary');
            summary.classList.remove('status-pendente', 'status-atendido');
            summary.classList.add(`status-${status || 'pendente'}`);
        }
        
        function setLoading(isLoading, text = "A carregar...") {
            loadingText.textContent = text;
            loadingOverlay.classList.toggle('hidden', !isLoading);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        function showTransferModal(patientId, patientName) {
            transferModal.dataset.patientId = patientId;
            document.getElementById('transfer-patient-name').textContent = `Paciente: ${patientName}`;
            transferModal.classList.remove('hidden');
        }

        function hideTransferModal() {
            transferModal.classList.add('hidden');
            delete transferModal.dataset.patientId;
        }

        async function confirmTransfer() {
            const patientId = transferModal.dataset.patientId;
            const newSector = document.getElementById('transfer-setor-select').value;
            if (patientId && newSector) {
                await updatePatient(patientId, { setor: newSector });
                hideTransferModal();
            }
        }
        
        document.getElementById('confirm-transfer-btn').addEventListener('click', confirmTransfer);
        document.getElementById('cancel-transfer-btn').addEventListener('click', hideTransferModal);

        new Sortable(patientContainer, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            onEnd: async (evt) => {
                const date = document.getElementById('filter-data').value;
                const batch = writeBatch(db);
                Array.from(evt.from.children).forEach((item, index) => {
                    if (item.id) {
                         const docRef = doc(db, "atendimentos", date, "pacientes", item.id);
                         batch.update(docRef, { order: index });
                    }
                });
                await batch.commit();
            }
        });

    </script>
</body>
</html>
